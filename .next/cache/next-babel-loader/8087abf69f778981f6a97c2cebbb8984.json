{"ast":null,"code":"import auth0 from 'auth0-js';\nimport Cookies from 'js-cookie';\nimport { getCooksFromReq } from '../lib/utils';\nimport jwt from 'jsonwebtoken';\nimport axios from 'axios';\nimport getConfig from 'next/config';\nconst {\n  publicRuntimeConfig\n} = getConfig();\n\nclass Auth0 {\n  constructor() {\n    this.auth0 = new auth0.WebAuth({\n      domain: 'dev-tn3cyve4.auth0.com',\n      clientID: `${publicRuntimeConfig.client_id}`,\n      redirectUri: `${publicRuntimeConfig.base_url}/login-success`,\n      responseType: 'token id_token',\n      scope: 'openid'\n    });\n    this.handleAuthentication = this.handleAuthentication.bind(this);\n    this.isAuthenticated = this.isAuthenticated.bind(this);\n  }\n\n  handleAuthentication() {\n    return new Promise((resolve, reject) => {\n      this.auth0.parseHash((err, authResult) => {\n        if (authResult && authResult.accessToken && authResult.idToken) {\n          this.setSession(authResult);\n          resolve();\n        } else if (err) {\n          reject(err);\n        }\n      });\n    });\n  }\n\n  setSession(authResult) {\n    let expiresAt = JSON.stringify(authResult.expiresIn * 1000 + new Date().getTime());\n    Cookies.set('x-jwt-exp', expiresAt);\n    Cookies.set('x-jwt', authResult.idToken);\n  }\n\n  login() {\n    this.auth0.authorize();\n  } // logout() {\n  //     Cookies.remove('x-jwt-exp')\n  //     Cookies.remove('x-jwt')\n  //     this.auth0.logout({\n  //         clientID: `${publicRuntimeConfig.client_id}`,\n  //         returnTo: `${publicRuntimeConfig.base_url}`\n  //     })\n  // }\n\n\n  async getJWST() {\n    const res = await axios.get('https://dev-tn3cyve4.auth0.com/.well-known/jwks.json');\n    const jwks = res.data;\n    return jwks;\n  }\n\n  certToPEM(cert) {\n    cert = cert.match(/.{1,64}/g).join('\\n');\n    cert = `-----BEGIN CERTIFICATE-----\\n${cert}\\n-----END CERTIFICATE-----\\n`;\n    return cert;\n  }\n\n  async verifyToken(token) {\n    if (token) {\n      // const decodeToken = jwt.decode(token, { complete: true })\n      const jwks = await this.getJWST();\n      const certificate = this.certToPEM(jwks.keys[0].x5c[0]);\n\n      try {\n        const decodedVerify = jwt.verify(token, certificate);\n        const expiredAt = decodedVerify.exp * 1000;\n        return decodedVerify && new Date().getTime() < expiredAt ? true : false;\n      } catch {\n        return false;\n      }\n    }\n\n    return false;\n  }\n\n  async isAuthenticated(req) {\n    if (false) {\n      const token = Cookies.get('x-jwt');\n      const verifyToken = await this.verifyToken(token);\n      return verifyToken;\n    } else {\n      let token = getCooksFromReq(req, 'x-jwt');\n      const verifyToken = await this.verifyToken(token);\n      return verifyToken;\n    }\n  } // async isAuthenticated(req) {\n  //     if(process.browser) {\n  //         let expiresAt = Cookies.get('x-jwt-exp')\n  //         return new Date().getTime() < expiresAt\n  //     } else {\n  //         let expiresAt = getCooksFromReq(req, 'x-jwt-exp')\n  //         return new Date().getTime() < expiresAt\n  //     }\n  // }\n\n\n}\n\nconst auth0Serv = new Auth0();\nexport default auth0Serv;","map":{"version":3,"sources":["/Users/disharjayantha/Desktop/projects,practise/Nextjs-PizzaApp/lib/appAuth.js"],"names":["auth0","Cookies","getCooksFromReq","jwt","axios","getConfig","publicRuntimeConfig","Auth0","constructor","WebAuth","domain","clientID","client_id","redirectUri","base_url","responseType","scope","handleAuthentication","bind","isAuthenticated","Promise","resolve","reject","parseHash","err","authResult","accessToken","idToken","setSession","expiresAt","JSON","stringify","expiresIn","Date","getTime","set","login","authorize","getJWST","res","get","jwks","data","certToPEM","cert","match","join","verifyToken","token","certificate","keys","x5c","decodedVerify","verify","expiredAt","exp","req","auth0Serv"],"mappings":"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","sourcesContent":["import auth0 from 'auth0-js'\nimport Cookies from 'js-cookie'\nimport { getCooksFromReq } from '../lib/utils'\n\nimport jwt from 'jsonwebtoken'\nimport axios from 'axios'\n\nimport getConfig from 'next/config'\nconst { publicRuntimeConfig } = getConfig()\n\nclass Auth0 {\n    constructor() {\n        this.auth0 = new auth0.WebAuth({\n            domain: 'dev-tn3cyve4.auth0.com',\n            clientID: `${publicRuntimeConfig.client_id}`,\n            redirectUri: `${publicRuntimeConfig.base_url}/login-success`,\n            responseType: 'token id_token',\n            scope: 'openid'\n        })\n        this.handleAuthentication = this.handleAuthentication.bind(this);\n        this.isAuthenticated = this.isAuthenticated.bind(this)\n    }\n\n    handleAuthentication() {\n        return new Promise((resolve, reject) => {\n            this.auth0.parseHash((err, authResult) => {\n                if (authResult && authResult.accessToken && authResult.idToken) {\n                  this.setSession(authResult);\n                  resolve()\n                } else if (err) {\n                  reject(err)\n                }\n              });\n        })\n    }\n\n    setSession(authResult) {\n        let expiresAt = JSON.stringify((authResult.expiresIn * 1000) + new Date().getTime())\n        Cookies.set('x-jwt-exp', expiresAt)\n        Cookies.set('x-jwt', authResult.idToken)\n    }\n\n    login() {\n        this.auth0.authorize()\n    }\n\n    // logout() {\n    //     Cookies.remove('x-jwt-exp')\n    //     Cookies.remove('x-jwt')\n    //     this.auth0.logout({\n    //         clientID: `${publicRuntimeConfig.client_id}`,\n    //         returnTo: `${publicRuntimeConfig.base_url}`\n    //     })\n    // }\n\n    async getJWST() {\n        const res = await axios.get('https://dev-tn3cyve4.auth0.com/.well-known/jwks.json')\n        const jwks = res.data\n        return jwks\n    }\n\n    certToPEM(cert) {\n        cert = cert.match(/.{1,64}/g).join('\\n');\n        cert = `-----BEGIN CERTIFICATE-----\\n${cert}\\n-----END CERTIFICATE-----\\n`;\n        return cert;\n      }\n\n    async verifyToken(token) {\n        if(token) {\n            // const decodeToken = jwt.decode(token, { complete: true })\n            const jwks = await this.getJWST()\n\n            const certificate = this.certToPEM(jwks.keys[0].x5c[0])\n            \n            try {\n                const decodedVerify = jwt.verify(token, certificate)\n                \n                const expiredAt = decodedVerify.exp * 1000\n\n                return (decodedVerify && new Date().getTime() < expiredAt ) ? true : false\n\n            } catch{\n                return false\n            }\n        }\n        return false\n    }\n\n    async isAuthenticated(req) {\n        if(process.browser) {\n            const token = Cookies.get('x-jwt')\n            const verifyToken = await this.verifyToken(token)\n            return verifyToken\n        } else {\n            let token = getCooksFromReq(req, 'x-jwt')\n            const verifyToken = await this.verifyToken(token)\n            return verifyToken\n        }\n    }\n\n    // async isAuthenticated(req) {\n    //     if(process.browser) {\n    //         let expiresAt = Cookies.get('x-jwt-exp')\n    //         return new Date().getTime() < expiresAt\n    //     } else {\n    //         let expiresAt = getCooksFromReq(req, 'x-jwt-exp')\n    //         return new Date().getTime() < expiresAt\n    //     }\n    // }\n} \n\nconst auth0Serv = new Auth0()\nexport default auth0Serv"]},"metadata":{},"sourceType":"module"}